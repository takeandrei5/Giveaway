version: '3.4'

services:
  nginx:
    image: giveaway-nginx
    build:
      context: .
      dockerfile: Nginx/Dockerfile
    ports:
      - 80:80
    container_name: giveaway-nginx
    depends_on:
      - webapi
      - webui

  webapi:
    image: giveaway-webapi
    build:
      context: ./Api
      dockerfile: WebApi/Dockerfile
    container_name: giveaway-webapi
    restart: on-failure
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT}
      - ASPNETCORE_URLS=${ASPNETCORE_URLS}
      - ConnectionStrings__DefaultConnection=${CONNECTION_STRING}
    ports:
      - 81:81
    depends_on:
      - mssql

  webui:
    image: giveaway-webui
    build:
      context: ./Ui
      dockerfile: ./Dockerfile
    container_name: giveaway_webui
    restart: on-failure
    ports:
      - 3000:3000
    environment:
      - BASE_URL=${BASE_URL}
      - AUTH0_SECRET=${AUTH0_SECRET}
      - AUTH0_BASE_URL=${AUTH0_BASE_URL}
      - AUTH0_AUDIENCE=${AUTH0_AUDIENCE}
      - AUTH0_ISSUER_BASE_URL=${AUTH0_ISSUER_BASE_URL}
      - AUTH0_SCOPE=${AUTH0_SCOPE}
      - AUTH0_CLIENT_ID=${AUTH0_CLIENT_ID}
      - AUTH0_CLIENT_SECRET=${AUTH0_CLIENT_SECRET}
      - NEXT_PUBLIC_BACKEND_URL=${NEXT_PUBLIC_BACKEND_URL}
    depends_on:
      - webapi
    volumes:
      - ./Ui:/app
      - /app/node_modules
      - /app/.next

  mssql:
    #image: mcr.microsoft.com/mssql/server:latest # if working on Windows
    image: mcr.microsoft.com/azure-sql-edge:latest # if working on MAC arm64
    user: root
    environment:
      - 'SA_PASSWORD=sa_password_123'
      - 'ACCEPT_EULA=Y'
    container_name: giveaway-mssql
    ports:
      - 1435:1433
    volumes:
      - dbdata:/var/opt/mssql/data

volumes:
  dbdata:
    name: giveaway-mssql
